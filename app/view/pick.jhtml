<!DOCTYPE html>
<html>
<head>
<title>Fancy Foodie</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<style type="text/css">
	#nav {
		height: 30px;
		padding-bottom: 2px;
	}
	body { 
		margin: 0px;
		padding: 0px
	}
	#remove, #recommend {
		display: none;
	}
</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript">
	var geolocation = (function() {
		if(navigator.geolocation) {
			return navigator.geolocation
		} else if ((window.google || window.google.gears) && google.gears) {
			return google.gears.factory.create('beta.geolocation')
		} else {
			return null
		}
	})()

	var pick = <%= params["data"].toSource() %>
	var referees = <%= params["referees"].toSource() %>
	var self_uid = <%= session["uid"] %>
	var map
	var user

	function updatePosition(position) {
		if(user) {
			user.setMap(null)
		}

		user = new google.maps.Marker({
			position: new google.maps.LatLng(position.coords.latitude,position.coords.longitude), 
			map: map,
			icon: "/public/img/user.gif",
			title:"Me!"
		})

		map.fitBounds(new google.maps.LatLngBounds(
			new google.maps.LatLng(Math.max(position.coords.latitude, pick.lat),
					       Math.min(position.coords.longitude, pick.lng)),
			new google.maps.LatLng(Math.min(position.coords.latitude, pick.lat),
					       Math.max(position.coords.longitude, pick.lng))))
	}

	$(document).ready(function () {
		if($.inArray(self_uid, referees) > -1) {
			$("#remove").click(function() {
				if(pick.referer_uid == self_uid) {
					if(confirm("remove " + pick.name + "?")) {
						$("#remove").attr("disabled", "disabled")
						$.post("/pick/remove/<%= params["key"] %>",
							function() {
								window.location = "/"	
							})
					}
				} else {
					$("#remove").attr("disabled", "disabled")
					$.post("/pick/remove/<%= params["key"] %>", 
						function() {
							$("#recommend").show()
							$("#remove").attr("disabled", "")
							$("#remove").hide()
						})
				}
			})

			$("#recommend").hide()
			$("#remove").show()
		} else if($.inArray(self_uid, referees) == -1 && self_uid != pick.referer_uid) {
			$("#recommend").click(function() {
				$("#recommend").attr("disabled", "disabled")
				$.post("/pick/recommend/<%= params["key"] %>",
					function() {
						$("#recommend").attr("disabled", "")
						$("#recommend").hide()
						$("#remove").show()
					})
			})

			$("#recommend").show()
			$("#remove").hide()
		}

		$("#add").click(function() {
			$.ajax({
				type: "POST",
				url: "/comments/post/" + pick.key,
				contentType: "application/json",
				dataType: 'json',
				data: JSON.stringify($("#comment").val()),
				success: function(msg) {
					$("#comments").append("<li>" + msg.comment + " - " + msg.author + ",  Just now</li>")
				}
			})
			$("#comment").val("")
		})

		var width = Math.min(960, $(window).width())
		$("#map").width(width)
		$("#map").height(3 * width / 4)

		map = new google.maps.Map(document.getElementById("map"), {
			zoom: 17,
			mapTypeControl: false,
			disableDoubleClickZoom: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		})


		var marker = new google.maps.Marker({
			position: new google.maps.LatLng(pick.lat, pick.lng), 
			map: map,
			title: pick.name + " by " + pick.referer_name
		})

		if(geolocation) {
			geolocation.getCurrentPosition(
				updatePosition,
				function() {
					map.setCenter(new google.maps.LatLng(pick.lat, pick.lng))
				},
				{ maximumAge: 0 })

			geolocation.watchPosition(updatePosition, function() {})
		} else {
			map.setCenter(new google.maps.LatLng(pick.lat, pick.lng))
		} 
	})
</script>
</head>
<body>
	<div id="nav">
		<input type="button" value="Listing" onclick="window.location='/'"/>
		<input type="button" value="Map" onclick="window.location='/#map'"/>
		<input type="button" id="recommend" value="Recommend"/>
		<input type="button" id="remove" value="Remove Recommendation"/>
	</div>
	<h1><%= params["data"].name %></h1>
	<p>by <%= params["data"].referer_name %></p>

	<div id="map"></div>

	<h2>comments</h2>

	<form>
		<p>
			<textarea id="comment" style="height: 90px; width: 300px"></textarea>
		</p>
		<p>
			<input type="button" id="add" value="Comment"/>
		</p>
	</form>

	<ul id="comments">
		<%
			var comments = params["comments"]
			for(var i = 0 ; i < comments.length ; i++) {
				echo("<li>")
				echo(comments[i].comment + " - " + comments[i].author + ", " + comments[i].timestamp)
				echo("</li>")
			}
		%>
	</ul>
</body>
</html>
