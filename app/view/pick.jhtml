<!DOCTYPE html>
<html>
<head>
<title>Fancy Foodie</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<style type="text/css">
	#nav {
		height: 40px;
	}
	body { 
		margin: 0px;
		padding: 0px
	}
	#remove, #recommend, #edit, #save, #cancel, #draggable {
		display: none;
	}
	#comments {
		margin-top: 18px;
		width: 100%;
		margin: 0;
                padding: 0;
	}
	#name_show {
                padding-left: 5px;
		font-size: 20px;
		font-weight: bold;
	}
	#tags_show, #referer {
		font-size: 10px;
		font-weight: normal;
	}
	#referer {
                padding-left: 5px;
		font-size: 10px;
		font-weight: normal;
	}
	#name_edit {
		display: none;
                margin: 0;
                padding: 5px 5px 0px 5px;
		width: 190px;
		height: 24px;
                font-size: 20px;
                font-weight: bold;
	}
	#tags_edit {
		display: none;
                margin: 0;
		width: 80px;
	}

	ul {
		width: 100%;
		margin: 0;
                padding: 0;
	}
	h1 {
                padding: 5px 5px 0px 5px;
                font-size: 16px;
                font-weight: bold;
	}
        li {
		width: 100%;
                margin: 0;
                padding: 0;
                display: block;
                list-style-type: none;
        }
        li h1 {
                margin: 0;
                padding: 5px 5px 0px 5px;
                font-size: 16px;
                font-weight: normal;
        }
        li h2 {
                margin: 0;
                padding: 3px 5px 5px 5px;
                font-size: 10px;
                font-weight: normal;
        }

</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/public/js/json2.js"></script>   
<script type="text/javascript" src="/public/js/geo.js"></script>   
<script type="text/javascript" src="/public/js/fsm.js"></script>   
<script type="text/javascript">
	var pick = <%= params["pick"].toSource() %>
	var editable = <%= params["editable"] %>
	var self_uid = <%= session["uid"] ? session["uid"] : "null" %>
	var map
	var user
	var marker
	var lastPosition

	function updatePosition(position) {
		if(state.state_name != "show" || (lastPosition && calcDist(lastPosition.coords.latitude, lastPosition.coords.longitude, position.coords.latitude, position.coords.longitude) <= 2)) {
			return
		}

		lastPosition = position;

		if(user) {
			user.setMap(null)
		}

		user = new google.maps.Marker({
			position: new google.maps.LatLng(position.coords.latitude,position.coords.longitude), 
			map: map,
			icon: "/public/img/user.gif",
			title:"Me!"
		})

		map.fitBounds(new google.maps.LatLngBounds(
			new google.maps.LatLng(Math.max(position.coords.latitude, pick.data.lat),
					       Math.min(position.coords.longitude, pick.data.lng)),
			new google.maps.LatLng(Math.min(position.coords.latitude, pick.data.lat),
					       Math.max(position.coords.longitude, pick.data.lng))))
	}

	$(document).ready(function () {
		var width = Math.min(960, $(window).width())
		$("#map_canvas").width(width)
		$("#map_canvas").height(3 * width / 4)

		map = new google.maps.Map(document.getElementById("map_canvas"), {
			zoom: 17,
			mapTypeControl: false,
			disableDoubleClickZoom: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		})


		if(geolocation) {
			geolocation.getCurrentPosition(
				updatePosition,
				function() {
					map.setCenter(new google.maps.LatLng(pick.data.lat, pick.data.lng))
				},
				{ maximumAge: 0 })

			geolocation.watchPosition(updatePosition, function() {})
		} else {
			map.setCenter(new google.maps.LatLng(pick.data.lat, pick.data.lng))
		}

		state = new FSM({
			start: function(fsm, event) {
				fsm.trans("show")
			},
			show: {
				onenter: function(fsm, event) {
					$("#name_show").html(pick.data.name)
					$("#tags_show").html("(" + (pick.data.tags && pick.data.tags.length > 0 ? pick.data.tags.join(" ") : "&lt;untagged&gt;") + ")")
					$("#list").show()
					$("#map").show()
					$("#comments").show()
					$("#name_show").show()
					$("#tags_show").show()

					if(marker) {
						marker.setMap(null)
					}

					marker = new google.maps.Marker({
						position: new google.maps.LatLng(pick.data.lat, pick.data.lng), 
						map: map,
						title: pick.data.name + " by " + pick.data.referer_name
					})

					if(!self_uid) {
						$("#recommend").hide()
						$("#remove").hide()
					} else if($.inArray(self_uid, pick.referees) > -1) {
						$("#remove").click(function() {
							if(pick.data.referer_uid == self_uid) {
								if(confirm("remove " + pick.data.name + "?")) {
									$("#remove").attr("disabled", "disabled")
									$.post("/pick/remove/" + pick.key,
										function() {
											window.location = "/"	
										})
								}
							} else {
								$("#remove").attr("disabled", "disabled")
								$.post("/pick/remove/" + pick.key, 
									function() {
										$("#recommend").show()
										$("#remove").attr("disabled", "")
										$("#remove").hide()
									})
							}
						})

						$("#recommend").hide()
						$("#remove").show()
					} else if($.inArray(self_uid, pick.referees) == -1 && self_uid != pick.data.referer_uid) {
						$("#recommend").click(function() {
							$("#recommend").attr("disabled", "disabled")
							$.post("/pick/recommend/" + pick.key,
								function() {
									$("#recommend").attr("disabled", "")
									$("#recommend").hide()
									$("#remove").show()
								})
						})

						$("#recommend").show()
						$("#remove").hide()
					}

					if(editable) {
						$("#edit").show()
					}
				},
				onexit: function(fsm, event) {
					$("#list").hide()
					$("#map").hide()
					$("#recommend").hide()
					$("#remove").hide()
					$("#comments").hide()
					$("#name_show").hide()
					$("#tags_show").hide()
				},
				EDIT: function(fsm, event) {
					fsm.trans("edit")	
				}
			},
			edit: {
				onenter: function(fsm, event) {
					$("#edit").hide()
					$("#save").show()
					$("#cancel").show()
					$("#name_edit").val(pick.data.name)
					$("#name_edit").show()
					$("#tags_edit").val(pick.data.tags ? pick.data.tags.join(" ") : "<add tags>")
					$("#tags_edit").show()
					$("#draggable").show()

					marker.setDraggable(true)
				},
				onexit: function(fsm, event) {
					$("#edit").show()
					$("#save").hide()
					$("#cancel").hide()
					$("#name_edit").hide()
					$("#tags_edit").hide()
					$("#draggable").hide()

					marker.setDraggable(false)
				},
				SHOW: function(fsm, event) {
					fsm.trans("show")
				}
			}
		})

		$("#edit").click(function() {
			state.handle("EDIT")
		})

		$("#save").click(function() {
			pick.data.name = $("#name_edit").val()
			pick.data.tags = $("#tags_edit").val()
			pick.data.tags = pick.data.tags == "<add tags>" ? "" : pick.data.tags
			pick.data.lat = marker.getPosition().lat()
			pick.data.lng = marker.getPosition().lng()

			$.ajax({
				type: "POST",
				url: "/pick/edit",
				contentType: "application/json",
				dataType: 'json',
				data: JSON.stringify(pick),
				success: function(p) {
					pick = p
					state.handle("SHOW")
				},
				error: function() {
					alert("something blew up")
				}
			})
		})

		$("#cancel").click(function() {
			state.handle("SHOW")
		})

		$("#add").click(function() {
			$.ajax({
				type: "POST",
				url: "/comments/post/" + pick.key,
				contentType: "application/json",
				dataType: 'json',
				data: JSON.stringify($("#comment").val()),
				success: function(msg) {
					$("#comment").val("")
					$("#comments ul").append("<li><h1>" + msg.comment + "</h1><h2>" + msg.author + ",  Just now</h2></li>")
				}
			})
			$("#comment textarea").val("")
		})

		state.start('startup')
	})
</script>
</head>
<body>
	<div id="nav">
		<input type="button" id="list" value="Listing" onclick="window.location='/'"/>
		<input type="button" id="map" value="Map" onclick="window.location='/#map'"/>
		<input type="button" id="edit" value="Edit"/>
		<input type="button" id="recommend" value="+ to Picks"/>
		<input type="button" id="remove" value="- from Picks"/>
		<input type="button" id="save" value="Save"/>
		<input type="button" id="cancel" value="Cancel"/>
	</div>

	<span id="name_show"></span><input id="name_edit" type="text"/>
	<span id="tags_show"></span><input id="tags_edit" type="text"/>
	<br/>	
	<span id="referer">by <%= params["pick"].data.referer_name %></span>
	<div id="comments">
		<h1>Comments</h1>
		<ul>
			<%
			var comments = params["pick"].comments
			for(var i = 0 ; i < comments.length ; i++) {
				echo("<li>")
				echo("<h1>" + comments[i].comment + "</h1><h2>" + comments[i].author + ", " + comments[i].timestamp + "</h2>")
				echo("</li>")
			}
			%>
		</ul>
		<textarea id="comment" style="height: 50px; width: 300px"></textarea>
		<input type="button" id="add" value="Comment"/>
	</div>
	<h1 id="draggable">tip: marker is now draggable</h1>
	<div id="map_canvas"></div>
</body>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18229677-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</html>
