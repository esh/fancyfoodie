<!DOCTYPE html>
<html>
<head>
<title>Fancy Foodie</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<style type="text/css">
	body { 
		margin: 0px;
		padding: 0px
	}
</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript">
	var geolocation = (function() {
		if(navigator.geolocation) {
			return navigator.geolocation
		} else if ((window.google || window.google.gears) && google.gears) {
			return google.gears.factory.create('beta.geolocation')
		} else {
			return null
		}
	})()

	var map

	$(document).ready(function () {
		<% if(session["uid"] == params["pick"].id.uid) { echo("$(\"#admin\").show()") } %>
		var pick = <%= params["pick"].toSource() %>

		$("#remove").click(function() {
			$.post("/pick/remove/" + pick.id.key,
				function() {
					window.location = "/"	
				})					
		})

		$("#add").click(function() {
			$.ajax({
				type: "POST",
				url: "/comments/post/" + pick.id.uid + "/" + pick.id.key,
				contentType: "application/json",
				dataType: 'json',
				data: JSON.stringify($("#comment").val()),
				success: function(msg) {
					$("#comments").append("<li>" + msg.comment + " - " + msg.author + ",  Just now</li>")
				}
			})
			$("#comment").val("")
		})

		var width = Math.min(960, $(window).width())
		$("#map").width(width)
		$("#map").height(3 * width / 4)

		map = new google.maps.Map(document.getElementById("map"), {
			zoom: 17,
			mapTypeControl: false,
			disableDoubleClickZoom: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		})


		var marker = new google.maps.Marker({
			position: new google.maps.LatLng(pick.lat, pick.lng), 
			map: map,
			title: pick.name + " by " + pick.referer
		})

		var user
		if(geolocation) {
			geolocation.getCurrentPosition(
				function(position) {
					user = new google.maps.Marker({
						position: new google.maps.LatLng(position.coords.latitude,position.coords.longitude), 
						map: map,
						title:"Me!"
					})

					map.fitBounds(new google.maps.LatLngBounds(
							new google.maps.LatLng(Math.max(position.coords.latitude, pick.lat),
									       Math.min(position.coords.longitude, pick.lng)),
							new google.maps.LatLng(Math.min(position.coords.latitude, pick.lat),
									       Math.max(position.coords.longitude, pick.lng))))


				},
				function() {
					alert("something went wrong")
				},
				{ maximumAge: 0 })

			geolocation.watchPosition(function(position) {
				},
				function() {
					alert("something went wrong")
				})
		} else {
			map.setCenter(new google.maps.LatLng(pick.lat, pick.lng))
		} 
	})
</script>
</head>
<body>
	<h1><%= params["pick"].name %></h1>
	<p>by <%= params["pick"].referer %></p>
	<div id="admin" style="display:none">
		<input type="button" id="remove" value="remove"/>
	</div>

	<div id="map"></div>

	<h2>comments</h2>
	<ul id="comments">
		<%
			var comments = params["comments"]
			for(var i = 0 ; i < comments.length ; i++) {
				echo("<li>")
				echo(comments[i].comment + " - " + comments[i].author + ", " + comments[i].timestamp)
				echo("</li>")
			}
		%>
	</ul>

	<form>
		<p>
			<input type="textarea" id="comment" style="height: 90px; width: 300px"/>
		</p>
		<p>
			<input type="button" id="add" value="Comment"/>
		</p>
	</form>
</body>
</html>
