<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<link type="text/css" rel="stylesheet" href="public/css/ui-lightness/jquery-ui-1.8.2.custom.css" media="all"/>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://connect.facebook.net/en_US/all.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/public/js/jquery-ui-1.8.2.custom.min.js"></script> 
<script type="text/javascript" src="/public/js/json2.js"></script>   
<script type="text/javascript" src="/public/js/fsm.js"></script>   

<script type="text/javascript">
	$(document).ready(function () {
		var myOptions = {
			zoom: 17,
			mapTypeControl: false,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		}
		var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions)

		if(navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				function(position) {
					map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude))
				},
				function() {})
		} else {
			map.setCenter(new google.maps.LatLng(-34.397, 150.644))
		}

		var controlText = document.createElement('DIV');
		controlText.style.fontSize = '12px';
		controlText.style.paddingLeft = '4px';
		controlText.style.paddingRight = '4px';
		controlText.innerHTML = "<a href=\"javascript:state.handle('PICK', null)\">add pick</a>";
		map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlText)

		state = new FSM({
			start: function(fsm, event) {
				<%
				if(!request.params["fbs_" + config.facebook_app_id]) {
					echo("fsm.trans('login')")
				} else {
					echo("fsm.trans('init')")
				}
				%>
			},
			login: {
				onenter: function(fsm, event) {
					$("#login").dialog({autoOpen: true,height: 300,width: 350,modal: true})
				},
				LOGIN: function(fsm, event) {
					$("#login").dialog('close')
					fsm.trans('init')
				}
			},
			init: {
				onenter: function(fsm, event) {
					// TODO: reset

					$.getJSON("/pick/fetch", function(msg) {
						for(var i = 0 ; i < msg.length ; i++) {
							var marker = new google.maps.Marker({
								position: new google.maps.LatLng(msg[i].lat, msg[i].lng), 
								map: map,
								title: msg[i].name 
							})
						}	
						fsm.trans('map')	
					})
				}
			},
			map: {
				PICK: function(fsm, event) {
					fsm.trans('new_pick')
				},
				LOGOUT: function(fsm, event) {
					fsm.trans('login')
				}
			},
			new_pick: {
				onenter: function(fsm, event) {
					google.maps.event.addListener(map, 'click', function(event) {
						$("#create_form").dialog({
							autoOpen: true,
							height: 300,
							width: 350,
							modal: true,
							buttons: {
								Add: function() {
									// TODO: start spinner?

									$.ajax({
										type: "POST",
										url: "/pick/post",
										contentType: "application/json",
										dataType: 'json',
										data: JSON.stringify({
											name: $("#name").val(),
											lat: event.latLng.lat(),
											lng: event.latLng.lng()
										}),
										success: function(msg) {
											var marker = new google.maps.Marker({
												position: event.latLng, 
												map: map,
												title: $("#name").val() 
											})
										
											// TODO: remove spinner
										}
									})


									$(this).dialog('close')
									google.maps.event.clearListeners(map, 'click')
									fsm.trans('map')
			
								},
								Cancel: function() {
									$(this).dialog('close')
									google.maps.event.clearListeners(map, 'click')
									fsm.trans('map')
								}
							},
							close: function() {
							}
						})
					})
				}
			}
		})

	

		FB.init({appId: '<%= config.facebook_app_id %>', status: true, cookie: true, xfbml: true})
		FB.Event.subscribe('auth.sessionChange', function(response) {
			if (response.session) {
				state.handle('LOGIN', null)
			} else {
				state.handle('LOGOUT', null)
			}
		})

		state.start('startup')
	})
</script>
</head>
<body>
	<div id="map_canvas" style="width:100%; height:100%"></div>

	<div id="login" title="login" style="display:none">
		<p>We use facebook to find your friend's recommendations! Please log in! blah blah blah!</p>
		<fb:login-button></fb:login-button>
	</div>

	<div id="create_form" title="add a hotspot" style="display:none">
		<form>
		<fieldset>
			<label for="name">Name</label>
			<input type="text" name="name" id="name" class="text ui-widget-content ui-corner-all"/>
		</fieldset>
		</form>
	</div>

	<div id="fb-root">
</body>
</html>
