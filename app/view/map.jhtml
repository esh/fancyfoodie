<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<link type="text/css" rel="stylesheet" href="public/css/ui-lightness/jquery-ui-1.8.2.custom.css" media="all"/>
<title>Fancy Foodie</title>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://connect.facebook.net/en_US/all.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/public/js/jquery-ui-1.8.2.custom.min.js"></script> 
<script type="text/javascript" src="/public/js/json2.js"></script>   
<script type="text/javascript" src="/public/js/fsm.js"></script>   

<script type="text/javascript">
	$(document).ready(function () {
		var map = new google.maps.Map(document.getElementById("map_canvas"), {
			zoom: 17,
			mapTypeControl: false,
			disableDoubleClickZoom: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		})

		if(navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(
				function(position) {
					map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude))
				},
				function() {})
		} else {
			map.setCenter(new google.maps.LatLng(-34.397, 150.644))
		}

		var markers = []
		function addMarker(pick) {
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(pick.lat, pick.lng), 
				map: map,
				title: pick.name + " by " + pick.referer
			})
			marker.id = pick.id
			markers.push(marker)
		}
		
		function addMarkerOnClick(marker, id) {
			google.maps.event.addListener(marker, 'click', function(event) {
				window.location = "/" + id.uid + "/" + id.key
			})
		}
	
		FB.init({appId: '<%= config.facebook_app_id %>', status: true, cookie: true, xfbml: true})

		state = new FSM({
			start: function(fsm, event) {
				FB.getLoginStatus(function(response) {
					if(response.session) {
						fsm.trans('init')
					} else {
						fsm.trans('login')
					}
				})
			},
			login: {
				onenter: function(fsm, event) {
					$("#login").dialog({
						autoOpen: true,
						height: 270,
						width: 300,
						modal: true,
						closeOnEscape: false,
   						open: function(event, ui) { $(".ui-dialog-titlebar-close").hide() }
					})
				},
				LOGIN: function(fsm, event) {
					$("#login").dialog('close')
					fsm.trans('init')
				}
			},
			init: {
				onenter: function(fsm, event) {
					for(var i = 0 ; i < markers.length ; i++) {
						markers.setMap(null)
					}
					markers = []

					$.getJSON("/pick/fetch", function(msgs) {
						for(var i = 0 ; i < msgs.length ; i++) {
							addMarker(msgs[i])
						}	
						fsm.trans('map')	
					})
				}
			},
			map: {
				onenter: function(fsm, event) {
					google.maps.event.addListener(map, 'dblclick', function(event) {
						fsm.trans('new_pick', event)
					})

					for(var i = 0 ; i < markers.length ; i++) {
						addMarkerOnClick(markers[i], markers[i].id)
					}
				},
				onexit: function(fsm, event) {
					$("helperText").hide()
					google.maps.event.clearListeners(map, 'dblclick')

					for(var i = 0 ; i < markers.length ; i++) {
						google.maps.event.clearListeners(markers[i], 'click')
					}
				},
				LOGOUT: function(fsm, event) {
					fsm.trans('login')
				},
				ADD: function(fsm, event) {
					fsm.trans('new_pick', event)
				}
			},
			new_pick: {
				onenter: function(fsm, event) {
					$("#create_form").dialog({
						autoOpen: true,
						height: 340,
						width: 300,
						modal: true,
						closeOnEscape: false,
   						open: function(event, ui) { 
							$(".ui-dialog-titlebar-close").hide()
							$("#name").val("")
							$("#comment").val("")
						},
						buttons: {
							Add: function() {
								$(this).dialog('close')
								// TODO: start spinner?
								$.ajax({
									type: "POST",
									url: "/pick/post",
									contentType: "application/json",
									dataType: 'json',
									data: JSON.stringify({
										name: $("#name").val(),
										lat: event.latLng.lat(),
										lng: event.latLng.lng(),
										comment: $("#comment").val()
									}),
									success: function(msg) {
										addMarker(msg)

										// TODO: remove spinner
										fsm.trans('map')
									},
									error: function(req, errorText, errorThrown) {
										// TODO: remove spinner
										fsm.trans('map')
									}
								})
							},
							Cancel: function() {
								$(this).dialog('close')
								fsm.trans('map')
							}
						}
					})
				},
				LOGOUT: function(fsm, event) {
					fsm.trans('login')
				}
			}
		})

		state.start('startup')

		var nav = document.createElement('div')
		nav.style.marginTop = "10px"

		var helperText = document.createElement('span')
		helperText.style.fontSize = "14px"
		helperText.innerHTML = "Double click map to add pick or"
		nav.appendChild(helperText)

		if(navigator.geolocation) {
			var currentLocationButton = document.createElement('input')
			currentLocationButton.id = "currentLocationButton"
			currentLocationButton.type = "button"
			currentLocationButton.value = "Add Current Location"
			currentLocationButton.style.fontSize = "14px"
			currentLocationButton.onclick = function() {
				navigator.geolocation.getCurrentPosition(
					function(position) {
						state.handle('ADD', { latLng: new google.maps.LatLng(position.coords.latitude,position.coords.longitude) })
					},
					function() {})
			}
			nav.appendChild(currentLocationButton)
		}

		map.controls[google.maps.ControlPosition.TOP].push(nav)

		FB.Event.subscribe('auth.sessionChange', function(response) {
			if (response.session) {
				state.handle('LOGIN', null)
			} else {
				state.handle('LOGOUT', null)
			}
		})
	})
</script>
</head>
<body>
	<div id="map_canvas" style="width:100%; height:100%"></div>

	<div id="login" title="login" style="display:none">
		<p>We use facebook to find your friend's recommendations! Please log in!</p>
		<p>This is an early ALPHA, it is pretty ugly, but the basic functionality is in place!</p>
		<fb:login-button></fb:login-button>
	</div>

	<div id="create_form" title="Drop a pick" style="display:none">
		<form>
			<p>
				<label for="name">Name</label>
				<input type="text" name="name" id="name"/>
			</p>
			<p>
				<label for="comment">Add a comment</label>
				<input type="textarea" name="comment" id="comment" style="height: 90px; width: 250px"/>
			</p>

		</form>
	</div>
	<div id="fb-root">
</body>
</html>
