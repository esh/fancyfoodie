<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<style type="text/css">
	html {
		height: 100% 
	}
	body { 
		height: 100%;
		margin: 0px;
		padding: 0px
	}
	#nav {
		position: absolute;
		top: 0px;
		height: 30px;
		font-size: 25px;
		padding-bottom: 2px;
	}
	#content {
		position: absolute;
		top: 30px; 
		width: 100%;
	}
	#list {
		width: 100%;
	}
	#add_pick {
		text-align: center;
	}
	#nav, #content, #listButton, #list, #map, #helperText, #create_form, #add_pick {
		display: none;
	}

</style>
<link type="text/css" rel="stylesheet" href="public/css/ui-lightness/jquery-ui-1.8.2.custom.css" media="all"/>
<title>Fancy Foodie</title>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/public/js/jquery-ui-1.8.2.custom.min.js"></script> 
<script type="text/javascript" src="/public/js/jquery.tablesorter.min.js"></script> 
<script type="text/javascript" src="/public/js/json2.js"></script>   
<script type="text/javascript" src="/public/js/fsm.js"></script>   
<script type="text/javascript">
	var geolocation = (function() {
		if(navigator.geolocation) {
			return navigator.geolocation
		} else if ((window.google || window.google.gears) && google.gears) {
			return google.gears.factory.create('beta.geolocation')
		} else {
			return null
		}
	})()

	var map
	var position
	var user
	var picks = <%= params["picks"].toSource() %> 

	function addMarker(pick) {
		var marker = new google.maps.Marker({
			position: new google.maps.LatLng(pick.lat, pick.lng), 
			map: map,
			title: pick.name + " by " + pick.referer
		})

		google.maps.event.addListener(marker, 'click', function(event) {
			window.location = "/" + pick.id.uid + "/" + pick.id.key
		})
	}

	function loadMap() {
		if(!map) {	
			map = new google.maps.Map(document.getElementById("map"), {
				zoom: 17,
				mapTypeControl: false,
				disableDoubleClickZoom: true,
				mapTypeId: google.maps.MapTypeId.ROADMAP
			})

			user = new google.maps.Marker({
				position: new google.maps.LatLng(position.coords.latitude,position.coords.longitude), 
				map: map,
				icon: "/public/img/user.gif",
				title:"Me!"
			})
			map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude))

			for(var i = 0 ; i < picks.length ; i++) {
				addMarker(picks[i])
			}
		}
	}


	function calcDist(lat1, lon1, lat2, lon2) {
		lat1 = lat1 * Math.PI / 180
		lat2 = lat2 * Math.PI / 180
		lon1 = lon1 * Math.PI / 180
		lon2 = lon2 * Math.PI / 180

		var R = 6371 // km
		var dLat = lat2-lat1
		var dLon = lon2-lon1 
		var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2) 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
		return parseInt(R * c * 100) / 100
	}

	function refreshList() {
		$("#list tbody").html("")
		for(var i = 0 ; i < picks.length ; i++) {
			$("#list tbody").append("<tr><td>" + calcDist(position.coords.latitude, position.coords.longitude, picks[i].lat, picks[i].lng) + "</td><td><a href=\"/" + picks[i].id.uid + "/" + picks[i].id.key + "\">" + picks[i].name + "</a></td><td>" + picks[i].referer + "</td></tr>")
		}
	}

	function updatePosition(p) {
		position = p
	
		if(user) {
			user.setMap(null)
			user = new google.maps.Marker({
				position: new google.maps.LatLng(position.coords.latitude,position.coords.longitude), 
				map: map,
				icon: "/public/img/user.gif",
				title:"Me!"
			})
		}

		refreshList()
	}

	$(document).ready(function () {
		$("#map").height($(window).height() - 30)
		$("#list").tablesorter()
		$("#listButton").click(function() {
			state.handle("LIST")		
		})
		$("#mapButton").click(function() {
			state.handle("MAP")		
		})
		$("#addButton").click(function() {
			state.handle("ADD")
		})

		state = new FSM({
			start: function(fsm, event) {
				fsm.trans('init')
			},
			init: {
				onenter: function(fsm, event) {
					function initPosition(p) {
						position = p

						var tokens = window.location.href.split("#")
						if(tokens.length > 1) {
							fsm.trans(tokens[1])
						} else {
							fsm.trans("list")
						}	
					}

					if(geolocation) {
						geolocation.getCurrentPosition(
							initPosition,
							function() {
								alert("something went wrong")
							},
							{ maximumAge: 0 })
						geolocation.watchPosition(
							updatePosition,
							function() {
							})
					} else {
						initPosition({
							coords: {
								latitude: 35.65857,
								longitude: 139.74542
							}
						})
					}
				},
				onexit: function(fsm, event) {
					$("#loading").hide()
					$("#nav").show()
					$("#content").show()
				}
			},
			list: {
				onenter: function(fsm, event) {
					refreshList()

					$("#list").trigger("update")
					$("#list").trigger("sorton", [[[0, 0]]])

					$("#map").hide()
					$("#listButton").hide()
					$("#list").show()
					$("#addButton").show()
					$("#mapButton").show()
				},
				onexit: function(fsm, event) {
				},
				MAP: function(fsm, event) {
					fsm.trans('map', event)
				},
				ADD: function(fsm, event) {
					fsm.trans('new_pick', event)
				}
			},
			map: {
				onenter: function(fsm, event) {	
					$("#list").hide()
					$("#mapButton").hide()
					$("#map").show()
					$("#addButton").show()
					$("#listButton").show()
					
					loadMap()
				},
				onexit: function(fsm, event) {
				},
				LIST: function(fsm, event) {
					fsm.trans('list', event)
				},
				ADD: function(fsm, event) {
					fsm.trans('new_pick', event)
				}
			},
			new_pick: {
				onenter: function(fsm, event) {
					var buttons = {
						"Map it": function() {
							$(this).dialog('close')
							fsm.trans('pick_marker')
						},
						Cancel: function() {
							$(this).dialog('close')
							// TODO: goto prev state
							fsm.trans('list')
						}
					}
					if(geolocation) {
						buttons["Add Here"] = function() {
							$(this).dialog('close')
							fsm.trans('add_marker', { latLng: new google.maps.LatLng(position.coords.latitude,position.coords.longitude) })
						}
					}

					$("#create_form").dialog({
						autoOpen: true,
						height: 340,
						width: 300,
						modal: true,
						closeOnEscape: false,
   						open: function(event, ui) { 
							$(".ui-dialog-titlebar-close").hide()
							$("#name").val("")
							$("#comment").val("")
						},
						buttons: buttons
					})
				},
			},
			pick_marker: {
				onenter: function(fsm, event) {
					$("#list").hide()
					$("#map").show()
					$("#mapButton").hide()
					$("#listButton").hide()
					$("#addButton").hide()
					$("#helperText").show()
					
					loadMap()
				
					google.maps.event.addListener(map, 'dblclick', function(event) {
						fsm.trans('add_marker', event)
					})

				},
				onexit: function(fsm, event) {
					$("#helperText").hide()
					google.maps.event.clearListeners(map, 'dblclick')
				},
			},
			add_marker: {
				onenter: function(fsm, event) {
					$("#add_pick").dialog({
						autoOpen: true,
						modal: true,
						closeOnEscape: false,
   						open: function(event, ui) { 
							$(".ui-dialog-titlebar-close").hide()
						}
					})

					$.ajax({
						type: "POST",
						url: "/pick/post",
						contentType: "application/json",
						dataType: 'json',
						data: JSON.stringify({
							name: $("#name").val(),
							lat: event.latLng.lat(),
							lng: event.latLng.lng(),
							comment: $("#comment").val()
						}),
						success: function(pick) {
							window.location = "/" + pick.id.uid + "/" + pick.id.key
						},
						error: function(req, errorText, errorThrown) {
							$("#add_pick").dialog("close")
							alert("something blew up")
							fsm.trans('list')
						}
					})
				}
			}
		})
		
		state.start('startup')
	})
</script>
</head>
<body>
	<div id="loading">
		<p>Locating current position...</p>
		<img src="/public/img/spinner.gif"/>	
	</div>

	<div id="nav">
		<input type="button" id="addButton" value="Add Pick"/>
		<input type="button" id="listButton" value="Listing"/>
		<input type="button" id="mapButton" value="Map"/>
		<span id="helperText">Double click on Map to add Pick</span> 
	</div>
	<div id="content">
		<table id="list">
			<thead>
				<th>km away</th>
				<th>name</th>
				<th>referer</th>
			</thead>
			<tbody/>
		</table>
		<div id="map" style="width:100%;height:100%"></div>
	</div>
	<div id="create_form" title="Add a pick">
		<form>
			<p>
				<label for="name">Name</label>
				<input type="text" name="name" id="name"/>
			</p>
			<p>
				<label for="comment">Add a comment</label>
				<input type="textarea" name="comment" id="comment" style="height: 90px; width: 250px"/>
			</p>
		</form>
	</div>
	<div id="add_pick">
		<p>Adding Pick...</p>
		<img src="/public/img/spinner.gif"/>	
	</div>
</body>
</html>
