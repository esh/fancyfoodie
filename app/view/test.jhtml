<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
	html {
		height: 100% 
	}
	body { 
		height: 100%;
		margin: 0px;
		padding: 0px
	}
	#nav {
		position: absolute;
		top: 0px;
		height: 25px;
	}
	#content {
		position: absolute;
		top: 25px; 
		width: 100%;
	}
	#listButton, #map, #helperText, #create_form {
		display: none;
	}

</style>
<link type="text/css" rel="stylesheet" href="public/css/ui-lightness/jquery-ui-1.8.2.custom.css" media="all"/>
<title>Fancy Foodie</title>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script>
<script type="text/javascript" src="/public/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/public/js/jquery-ui-1.8.2.custom.min.js"></script> 
<script type="text/javascript" src="/public/js/json2.js"></script>   
<script type="text/javascript" src="/public/js/fsm.js"></script>   

<script type="text/javascript">
	var geolocation = (function() {
		if(navigator.geolocation) {
			return navigator.geolocation
		} else if (window.google || window.google.gears) {
			return google.gears.factory.create('beta.geolocation')
		} else {
			return null
		}
	})()

	var map
	var markers = []
	function addMarker(map, pick) {
		var marker = new google.maps.Marker({
			position: new google.maps.LatLng(pick.lat, pick.lng), 
			map: map,
			title: pick.name + " by " + pick.referer
		})
		marker.id = pick.id
		markers.push(marker)
	}

	function addMarkerOnClick(marker, id) {
		google.maps.event.addListener(marker, 'click', function(event) {
			window.location = "/" + id.uid + "/" + id.key
		})
	}

	$(document).ready(function () {
		$("#map").height($(window).height() - 25)
		$("#listButton").click(function() {
			state.handle("LIST")		
		})
		$("#mapButton").click(function() {
			state.handle("MAP")		
		})

		state = new FSM({
			start: function(fsm, event) {
				fsm.trans('init')
			},
			init: {
				onenter: function(fsm, event) {
/*
					$.getJSON("/pick/fetch", function(msgs) {
						for(var i = 0 ; i < msgs.length ; i++) {
							addMarker(map, msgs[i])
						}	
					})
*/
					fsm.trans('list')
				}
			},
			list: {
				onenter: function(fsm, event) {
					$("#list").show()
					$("#addButton").show()
					$("#listButton").hide()
				},
				onexit: function(fsm, event) {
					$("#list").hide()
					$("#listButton").show()
				},
				MAP: function(fsm, event) {
					fsm.trans('map', event)
				},
				ADD: function(fsm, event) {
					fsm.trans('new_pick', event)
				}
			},
			map: {
				onenter: function(fsm, event) {
					$("#map").show()
					$("#addButton").show()
					$("#mapButton").hide()
					
					if(!map) {	
						map = new google.maps.Map(document.getElementById("map"), {
							zoom: 17,
							mapTypeControl: false,
							disableDoubleClickZoom: true,
							mapTypeId: google.maps.MapTypeId.ROADMAP
						})

						if(geolocation) {
							geolocation.getCurrentPosition(
								function(position) {
									map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude))
								},
								function() {})
						} else {
							map.setCenter(new google.maps.LatLng(35.65857, 139.74542))
						}
					}

/*
					for(var i = 0 ; i < markers.length ; i++) {
						addMarkerOnClick(markers[i], markers[i].id)
					}
*/
				},
				onexit: function(fsm, event) {
					$("#map").hide()
					$("#mapButton").show()

					for(var i = 0 ; i < markers.length ; i++) {
						google.maps.event.clearListeners(markers[i], 'click')
					}
				},
				LIST: function(fsm, event) {
					fsm.trans('list', event)
				},
				ADD: function(fsm, event) {
					fsm.trans('new_pick', event)
				}
			},
			new_pick: {
				onenter: function(fsm, event) {
					var buttons = {
						"Map it": function() {
							$(this).dialog('close')
							fsm.trans('pick_marker')
						},
						Cancel: function() {
							$(this).dialog('close')
							// TODO: goto prev state
							fsm.trans('list')
						}
					}
					if(geolocation) {
						buttons["Add Here"] = function() {
							$(this).dialog('close')
							geolocation.getCurrentPosition(
								function(position) {
									fsm.trans('add_marker', { latLng: new google.maps.LatLng(position.coords.latitude,position.coords.longitude) })
								},
								function() {})
						}
					}

					$("#create_form").dialog({
						autoOpen: true,
						height: 340,
						width: 300,
						modal: true,
						closeOnEscape: false,
   						open: function(event, ui) { 
							$(".ui-dialog-titlebar-close").hide()
							$("#name").val("")
							$("#comment").val("")
						},
						buttons: buttons
					})
				},
			},
			pick_marker: {
				onenter: function(fsm, event) {
					$("#map").show()
					$("#listButton").hide()
					$("#addButton").hide()
					$("#helperText").show()
					
					google.maps.event.addListener(map, 'dblclick', function(event) {
						fsm.trans('add_marker', event)
					})

				},
				onexit: function(fsm, event) {
					$("#helperText").hide()
					google.maps.event.clearListeners(map, 'dblclick')
				},
			},
			add_marker: {
				onenter: function(fsm, event) {
					// TODO: start spinner?
					$.ajax({
						type: "POST",
						url: "/pick/post",
						contentType: "application/json",
						dataType: 'json',
						data: JSON.stringify({
							name: $("#name").val(),
							lat: event.latLng.lat(),
							lng: event.latLng.lng(),
							comment: $("#comment").val()
						}),
						success: function(msg) {
							addMarker(map, msg)

							// TODO: remove spinner
							fsm.trans('map')
						},
						error: function(req, errorText, errorThrown) {
							// TODO: remove spinner
							fsm.trans('map')
						}
					})
				}
			}
		})
		
		state.start('startup')
	})
</script>
</head>
<body>
	<div id="nav">
		<input type="button" id="addButton" value="Add Pick"/>
		<input type="button" id="listButton" value="Listing"/>
		<input type="button" id="mapButton" value="Map"/>
		<span id="helperText">Double click on Map to add Pick</span> 
	</div>
	<div id="content">
		<div id="list">
			<ul>
				<li>one banana</li>
				<li>two banana</li>
			</ul>
		</div>
		<div id="map" style="width:100%;height:100%"></div>
	</div>
	<div id="create_form" title="Drop a pick">
		<form>
			<p>
				<label for="name">Name</label>
				<input type="text" name="name" id="name"/>
			</p>
			<p>
				<label for="comment">Add a comment</label>
				<input type="textarea" name="comment" id="comment" style="height: 90px; width: 250px"/>
			</p>
		</form>
	</div>
</body>
</html>
